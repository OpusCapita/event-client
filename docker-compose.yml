version: '2'
services:
    main:
        build: .
        volumes:
            - .:/home/node/event-client
        depends_on:
            - registrator
            - rabbitmq
        environment:
            RABBITMQ_USER: $RABBITMQ_USER
            RABBITMQ_PASS: $RABBITMQ_PASS
        command: npm run test-raw

    rabbitmq:
        image: rabbitmq:3-management
        ports:
            - '4369:4369'
            - '5671:5671'
            - '5672:5672'
            - '15672:15672'
        environment:
            RABBITMQ_DEFAULT_USER: $RABBITMQ_USER
            RABBITMQ_DEFAULT_PASS: $RABBITMQ_PASS
            SERVICE_5672_NAME: 'amqp'

    registrator:
        image: gliderlabs/registrator
        command: consul://consul:8500
        volumes:
            - /var/run/docker.sock:/tmp/docker.sock
        depends_on:
            - consul

    consul:
        image: consul:latest
        ports:
            - '8400:8400'
            - '8500:8500'
            - '8600:53/udp'
        labels:
            SERVICE_IGNORE: 'true'  # Do not add any of Consul's services to Consul's service discovery registry.
        command: [agent, '-server', '-ui', '-bootstrap', '-client=0.0.0.0']
